<!DOCTYPE html>
<html lang="ko">
<head>
  <meta charset="UTF-8">
  <title>DBpia 논문 추천</title>
  <style>
    * { box-sizing: border-box; }
    body { font-family: 'Segoe UI', sans-serif; background: #f5f7fa; margin: 0; }
    .container {
      max-width: 800px;
      margin: 40px auto;
      background: white;
      padding: 30px 40px;
      border-radius: 12px;
      box-shadow: 0 8px 20px rgba(0,0,0,0.1);
    }
    h1 { text-align: center; color: #333; }
    button {
      padding: 8px 16px;
      background: #007BFF; color: white;
      border: none; border-radius: 6px;
      cursor: pointer; font-size: 14px;
    }
    button:hover { background: #0056b3; }

    /* ─────────── flex form-row ─────────── */
    .form-row {
      display: flex;
      flex-wrap: wrap;
      gap: 12px;
      margin-bottom: 16px;
      align-items: center;
    }
    .form-row label {
      display: flex;
      align-items: center;
      gap: 8px;
      font-weight: 600;
      flex: 1;
    }
    .form-row input,
    .form-row select {
      flex: 1;
      padding: 6px 8px;
      border: 1px solid #ccc;
      border-radius: 4px;
    }

    /* 상단바 */
    #top-bar { display: flex; justify-content: flex-end; gap: 10px; margin-bottom: 20px; }
    #greeting { font-weight: 600; align-self: center; }
    #logout { display: none; } /* 처음에는 숨김 */

    /* 모달 공통 스타일 */
    .modal {
      display: none;
      position: fixed; top: 0; left: 0;
      width: 100%; height: 100%;
      background: rgba(0,0,0,0.5);
      align-items: center; justify-content: center;
      z-index: 1000;
    }
    .modal.active { display: flex; }
    .modal-content {
      background: #fff;
      padding: 20px 30px;
      border-radius: 8px;
      width: 360px;
      position: relative;
    }
    .modal-content h2 { margin: 0 0 16px; text-align: center; }
    .modal-close {
      position: absolute; top: 10px; right: 12px;
      background: none; border: none; font-size: 18px;
      cursor: pointer;
    }
    .message { color: green; font-size: 0.9em; text-align: center; margin-top: 8px; }

    /* 추천 섹션 스타일 */
    .subject-group { margin-top: 10px; padding-left: 10px; }
    .subject-group label { display: inline-block; margin-right: 15px; font-weight: normal; }
    #result { margin-top: 40px; }
    .paper { background: #f1f4f8; padding: 16px 20px; border-radius: 10px; margin-bottom: 15px; border-left: 5px solid #007BFF; }
    .paper strong { font-size: 18px; color: #222; }
    .paper em { color: #666; display: block; margin-top: 4px; font-style: normal; }
    .paper a { display: inline-block; margin-top: 8px; color: #007BFF; text-decoration: none; }
    .paper a:hover { text-decoration: underline; }
  </style>
</head>
<body>
  <div class="container">
    <h1>📚 DBpia 인기 논문 추천 시스템</h1>

    <!-- 상단바 -->
    <div id="top-bar">
      <button id="open-signup">회원가입</button>
      <button id="open-login">로그인</button>
      <span id="greeting"></span>
      <button id="open-mypage" style="display:none;">마이페이지</button>
      <button id="logout">로그아웃</button>
    </div>

    <!-- 추천 폼 -->
    <form id="recommend-form">
      <div class="form-row">
        <label>연도 선택
          <select name="pyear">
            <option value="">(선택 안 함)</option>
            <option value="2024">2024</option>
            <option value="2023">2023</option>
          </select>
        </label>
        <label>월 선택
          <select name="pmonth">
            <option value="">(선택 안 함)</option>
            <option value="01">1월</option>
            <option value="02">2월</option>
            <option value="03">3월</option>
            <option value="04">4월</option>
            <option value="05">5월</option>
            <option value="06">6월</option>
            <option value="07">7월</option>
            <option value="08">8월</option>
            <option value="09">9월</option>
            <option value="10">10월</option>
            <option value="11">11월</option>
            <option value="12">12월</option>
          </select>
        </label>
      </div>
      <div class="form-row">
        <label>주제 분류:</label>
        <div class="subject-group">
          <label><input type="radio" name="category" value="">전체</label>
          <label><input type="radio" name="category" value="1">인문학</label>
          <label><input type="radio" name="category" value="2">사회과학</label>
          <label><input type="radio" name="category" value="3">자연과학</label>
          <label><input type="radio" name="category" value="4">공학</label>
          <label><input type="radio" name="category" value="5">의약학</label>
          <label><input type="radio" name="category" value="6">농수해양</label>
          <label><input type="radio" name="category" value="7">예술체육</label>
          <label><input type="radio" name="category" value="8">복합학</label>
          <label><input type="radio" name="category" value="9">교양</label>
        </div>
      </div>
      <button type="submit">논문 추천받기</button>
    </form>

    <div id="result"></div>
  </div>

  <!-- 회원가입 모달 -->
  <div id="modal-signup" class="modal">
    <div class="modal-content">
      <button class="modal-close" data-close="modal-signup">&times;</button>
      <h2>회원가입</h2>
      <form id="signup-form">
        <div class="form-row">
          <label>아이디
            <input type="text" name="username" required minlength="3">
          </label>
        </div>
        <div class="form-row">
          <label>비밀번호
            <input type="password" name="password" required minlength="6">
          </label>
        </div>
        <button type="submit">가입하기</button>
      </form>
      <div id="signup-msg" class="message"></div>
    </div>
  </div>

  <!-- 로그인 모달 -->
  <div id="modal-login" class="modal">
    <div class="modal-content">
      <button class="modal-close" data-close="modal-login">&times;</button>
      <h2>로그인</h2>
      <form id="login-form">
        <div class="form-row">
          <label>아이디
            <input type="text" name="username" required>
          </label>
        </div>
        <div class="form-row">
          <label>비밀번호
            <input type="password" name="password" required>
          </label>
        </div>
        <button type="submit">로그인</button>
      </form>
      <div id="login-msg" class="message"></div>
    </div>
  </div>

  <!-- 마이페이지 모달 -->
  <div id="modal-mypage" class="modal">
    <div class="modal-content">
      <button class="modal-close" data-close="modal-mypage">&times;</button>
      <h2>비밀번호 변경</h2>
      <form id="mypage-form">
        <div class="form-row">
          <label>현재 비밀번호
            <input type="password" name="old_password" required minlength="6">
          </label>
        </div>
        <div class="form-row">
          <label>새 비밀번호
            <input type="password" name="new_password" required minlength="6">
          </label>
        </div>
        <button type="submit">변경하기</button>
      </form>
      <div id="mypage-msg" class="message"></div>
    </div>
  </div>

  <script>
    // 모달 제어
    const openModal = id => document.getElementById(id).classList.add('active');
    const closeModal = id => document.getElementById(id).classList.remove('active');
    document.getElementById('open-signup').onclick = () => openModal('modal-signup');
    document.getElementById('open-login').onclick  = () => openModal('modal-login');
    document.getElementById('open-mypage').onclick = () => openModal('modal-mypage');
    document.querySelectorAll('.modal').forEach(m => {
      m.addEventListener('click', e => e.target===m && closeModal(m.id));
    });
    document.querySelectorAll('.modal-close').forEach(b => {
      b.onclick = () => closeModal(b.dataset.close);
    });

    // 인사말·로그아웃 표시 함수
    function showGreeting(username) {
      document.getElementById('open-signup').style.display = 'none';
      document.getElementById('open-login').style.display  = 'none';
      document.getElementById('logout').style.display      = 'inline-block';
      document.getElementById('greeting').textContent      = `${username}님, 반갑습니다!`;
      document.getElementById('open-mypage').style.display = 'inline-block';
    }

    // 로그아웃 처리
    document.getElementById('logout').onclick = () => {
      localStorage.removeItem('token');
      localStorage.removeItem('username');
      window.location.reload();  // 새로고침해서 초기 상태로
    };

    // 초기 로드 시 이미 로그인된 상태면 인사말·로그아웃 표시
    window.addEventListener('DOMContentLoaded', () => {
      const user = localStorage.getItem('username');
      if (user) showGreeting(user);
    });

    // 메시지 헬퍼
    const showMessage = (id, txt) => document.getElementById(id).textContent = txt;

    // 회원가입 AJAX
    document.getElementById('signup-form').addEventListener('submit', async e => {
      e.preventDefault();
      const data = Object.fromEntries(new FormData(e.target));
      const res  = await fetch('/auth/register', {
        method: 'POST',
        headers: {'Content-Type':'application/json'},
        body: JSON.stringify(data)
      });
      if (res.ok) {
        showMessage('signup-msg','가입 성공! 로그인 해주세요.');
      } else {
        const err = await res.json();
        showMessage('signup-msg', err.detail || '가입 실패');
      }
    });

    // 로그인 AJAX
    document.getElementById('login-form').addEventListener('submit', async e => {
      e.preventDefault();
      const form = new URLSearchParams(new FormData(e.target));
      const res  = await fetch('/auth/token', {
        method: 'POST',
        headers: {'Content-Type':'application/x-www-form-urlencoded'},
        body: form
      });
      if (res.ok) {
        const { access_token } = await res.json();
        const user = form.get('username');
        localStorage.setItem('token', access_token);
        localStorage.setItem('username', user);
        showGreeting(user);
        closeModal('modal-login');
      } else {
        const err = await res.json();
        showMessage('login-msg', err.detail || '로그인 실패');
      }
    });

    // 추천 폼 AJAX
    document.getElementById('recommend-form').addEventListener('submit', async e => {
      e.preventDefault();
      const params = new URLSearchParams(new FormData(e.target)).toString();
      const token  = localStorage.getItem('token');
      const res    = await fetch(`/recommend?${params}`, {
        headers: token ? {'Authorization':`Bearer ${token}`} : {}
      });
      const { recommendations = [] } = await res.json().catch(()=>({ recommendations: [] }));
      document.getElementById('result').innerHTML = recommendations.length
        ? recommendations.map(item => `
            <div class="paper">
              <strong>${item.title}</strong>
              <em>저자: ${item.authors.map(a=>a.name).join(', ')}</em>
              <p>간행물: ${item.publication.name||'N/A'}</p>
              <a href="${item.link_url}" target="_blank">상세 보기</a>
            </div>
          `).join('')
        : '<p>추천된 논문이 없습니다.</p>';
    });

    // 마이페이지(비밀번호 변경) 폼 처리
    document.getElementById('mypage-form').addEventListener('submit', async e => {
      e.preventDefault();
      const data = Object.fromEntries(new FormData(e.target));
      const token = localStorage.getItem('token');
      const res = await fetch('/mypage/password', {
        method: 'PATCH',
        headers: {
          'Content-Type': 'application/json',
          'Authorization': `Bearer ${token}`
        },
        body: JSON.stringify(data)
      });
      if (res.ok) {
        showMessage('mypage-msg','✅ 비밀번호가 변경되었습니다.');
        setTimeout(()=>closeModal('modal-mypage'), 1000);
      } else {
        const err = await res.json();
        showMessage('mypage-msg', err.detail || '❌ 변경 실패');
      }
    });

  </script>
</body>
</html>
