<!DOCTYPE html>
<html lang="ko">
<head>
  <meta charset="UTF-8">
  <title>DBpia ë…¼ë¬¸ ì¶”ì²œ</title>
  <style>
    * { box-sizing: border-box; }
    body { font-family: 'Segoe UI', sans-serif; background: #f5f7fa; margin: 0; }
    .container {
      max-width: 800px;
      margin: 40px auto;
      background: white;
      padding: 30px 40px;
      border-radius: 12px;
      box-shadow: 0 8px 20px rgba(0,0,0,0.1);
    }
    h1 { text-align: center; color: #333; }
    button {
      padding: 8px 16px;
      background: #007BFF; color: white;
      border: none; border-radius: 6px;
      cursor: pointer; font-size: 14px;
    }
    button:hover { background: #0056b3; }

    /* â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€ flex form-row â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€ */
    .form-row {
      display: flex;
      flex-wrap: wrap;
      gap: 12px;
      margin-bottom: 16px;
      align-items: center;
    }
    .form-row label {
      display: flex;
      align-items: center;
      gap: 8px;
      font-weight: 600;
      flex: 1;
    }
    .form-row input,
    .form-row select {
      flex: 1;
      padding: 6px 8px;
      border: 1px solid #ccc;
      border-radius: 4px;
    }

    /* ìƒë‹¨ë°” */
    #top-bar { display: flex; justify-content: flex-end; gap: 10px; margin-bottom: 20px; }
    #greeting { font-weight: 600; align-self: center; }
    #logout { display: none; } /* ì²˜ìŒì—ëŠ” ìˆ¨ê¹€ */

    /* ëª¨ë‹¬ ê³µí†µ ìŠ¤íƒ€ì¼ */
    .modal {
      display: none;
      position: fixed; top: 0; left: 0;
      width: 100%; height: 100%;
      background: rgba(0,0,0,0.5);
      align-items: center; justify-content: center;
      z-index: 1000;
    }
    .modal.active { display: flex; }
    .modal-content {
      background: #fff;
      padding: 20px 30px;
      border-radius: 8px;
      width: 360px;
      position: relative;
    }
    .modal-content h2 { margin: 0 0 16px; text-align: center; }
    .modal-close {
      position: absolute; top: 10px; right: 12px;
      background: none; border: none; font-size: 18px;
      cursor: pointer;
    }
    .message { color: green; font-size: 0.9em; text-align: center; margin-top: 8px; }

    /* ì¶”ì²œ ì„¹ì…˜ ìŠ¤íƒ€ì¼ */
    .subject-group { margin-top: 10px; padding-left: 10px; }
    .subject-group label { display: inline-block; margin-right: 15px; font-weight: normal; }
    #result { margin-top: 40px; }
    .paper { background: #f1f4f8; padding: 16px 20px; border-radius: 10px; margin-bottom: 15px; border-left: 5px solid #007BFF; }
    .paper strong { font-size: 18px; color: #222; }
    .paper em { color: #666; display: block; margin-top: 4px; font-style: normal; }
    .paper a { display: inline-block; margin-top: 8px; color: #007BFF; text-decoration: none; }
    .paper a:hover { text-decoration: underline; }
  </style>
</head>
<body>
  <div class="container">
    <h1>ğŸ“š DBpia ì¸ê¸° ë…¼ë¬¸ ì¶”ì²œ ì‹œìŠ¤í…œ</h1>

    <!-- ìƒë‹¨ë°” -->
    <div id="top-bar">
      <button id="open-signup">íšŒì›ê°€ì…</button>
      <button id="open-login">ë¡œê·¸ì¸</button>
      <span id="greeting"></span>
      <button id="open-mypage" style="display:none;">ë§ˆì´í˜ì´ì§€</button>
      <button id="logout">ë¡œê·¸ì•„ì›ƒ</button>
    </div>

    <!-- ì¶”ì²œ í¼ -->
    <form id="recommend-form">
      <div class="form-row">
        <label>ì—°ë„ ì„ íƒ
          <select name="pyear">
            <option value="">(ì„ íƒ ì•ˆ í•¨)</option>
            <option value="2024">2024</option>
            <option value="2023">2023</option>
          </select>
        </label>
        <label>ì›” ì„ íƒ
          <select name="pmonth">
            <option value="">(ì„ íƒ ì•ˆ í•¨)</option>
            <option value="01">1ì›”</option>
            <option value="02">2ì›”</option>
            <option value="03">3ì›”</option>
            <option value="04">4ì›”</option>
            <option value="05">5ì›”</option>
            <option value="06">6ì›”</option>
            <option value="07">7ì›”</option>
            <option value="08">8ì›”</option>
            <option value="09">9ì›”</option>
            <option value="10">10ì›”</option>
            <option value="11">11ì›”</option>
            <option value="12">12ì›”</option>
          </select>
        </label>
      </div>
      <div class="form-row">
        <label>ì£¼ì œ ë¶„ë¥˜:</label>
        <div class="subject-group">
          <label><input type="radio" name="category" value="">ì „ì²´</label>
          <label><input type="radio" name="category" value="1">ì¸ë¬¸í•™</label>
          <label><input type="radio" name="category" value="2">ì‚¬íšŒê³¼í•™</label>
          <label><input type="radio" name="category" value="3">ìì—°ê³¼í•™</label>
          <label><input type="radio" name="category" value="4">ê³µí•™</label>
          <label><input type="radio" name="category" value="5">ì˜ì•½í•™</label>
          <label><input type="radio" name="category" value="6">ë†ìˆ˜í•´ì–‘</label>
          <label><input type="radio" name="category" value="7">ì˜ˆìˆ ì²´ìœ¡</label>
          <label><input type="radio" name="category" value="8">ë³µí•©í•™</label>
          <label><input type="radio" name="category" value="9">êµì–‘</label>
        </div>
      </div>
      <button type="submit">ë…¼ë¬¸ ì¶”ì²œë°›ê¸°</button>
    </form>

    <div id="result"></div>
  </div>

  <!-- íšŒì›ê°€ì… ëª¨ë‹¬ -->
  <div id="modal-signup" class="modal">
    <div class="modal-content">
      <button class="modal-close" data-close="modal-signup">&times;</button>
      <h2>íšŒì›ê°€ì…</h2>
      <form id="signup-form">
        <div class="form-row">
          <label>ì•„ì´ë””
            <input type="text" name="username" required minlength="3">
          </label>
        </div>
        <div class="form-row">
          <label>ë¹„ë°€ë²ˆí˜¸
            <input type="password" name="password" required minlength="6">
          </label>
        </div>
        <button type="submit">ê°€ì…í•˜ê¸°</button>
      </form>
      <div id="signup-msg" class="message"></div>
    </div>
  </div>

  <!-- ë¡œê·¸ì¸ ëª¨ë‹¬ -->
  <div id="modal-login" class="modal">
    <div class="modal-content">
      <button class="modal-close" data-close="modal-login">&times;</button>
      <h2>ë¡œê·¸ì¸</h2>
      <form id="login-form">
        <div class="form-row">
          <label>ì•„ì´ë””
            <input type="text" name="username" required>
          </label>
        </div>
        <div class="form-row">
          <label>ë¹„ë°€ë²ˆí˜¸
            <input type="password" name="password" required>
          </label>
        </div>
        <button type="submit">ë¡œê·¸ì¸</button>
      </form>
      <div id="login-msg" class="message"></div>
    </div>
  </div>

  <!-- ë§ˆì´í˜ì´ì§€ ëª¨ë‹¬ -->
  <div id="modal-mypage" class="modal">
    <div class="modal-content">
      <button class="modal-close" data-close="modal-mypage">&times;</button>
      <h2>ë¹„ë°€ë²ˆí˜¸ ë³€ê²½</h2>
      <form id="mypage-form">
        <div class="form-row">
          <label>í˜„ì¬ ë¹„ë°€ë²ˆí˜¸
            <input type="password" name="old_password" required minlength="6">
          </label>
        </div>
        <div class="form-row">
          <label>ìƒˆ ë¹„ë°€ë²ˆí˜¸
            <input type="password" name="new_password" required minlength="6">
          </label>
        </div>
        <button type="submit">ë³€ê²½í•˜ê¸°</button>
      </form>
      <div id="mypage-msg" class="message"></div>
    </div>
  </div>

  <script>
    // ëª¨ë‹¬ ì œì–´
    const openModal = id => document.getElementById(id).classList.add('active');
    const closeModal = id => document.getElementById(id).classList.remove('active');
    document.getElementById('open-signup').onclick = () => openModal('modal-signup');
    document.getElementById('open-login').onclick  = () => openModal('modal-login');
    document.getElementById('open-mypage').onclick = () => openModal('modal-mypage');
    document.querySelectorAll('.modal').forEach(m => {
      m.addEventListener('click', e => e.target===m && closeModal(m.id));
    });
    document.querySelectorAll('.modal-close').forEach(b => {
      b.onclick = () => closeModal(b.dataset.close);
    });

    // ì¸ì‚¬ë§Â·ë¡œê·¸ì•„ì›ƒ í‘œì‹œ í•¨ìˆ˜
    function showGreeting(username) {
      document.getElementById('open-signup').style.display = 'none';
      document.getElementById('open-login').style.display  = 'none';
      document.getElementById('logout').style.display      = 'inline-block';
      document.getElementById('greeting').textContent      = `${username}ë‹˜, ë°˜ê°‘ìŠµë‹ˆë‹¤!`;
      document.getElementById('open-mypage').style.display = 'inline-block';
    }

    // ë¡œê·¸ì•„ì›ƒ ì²˜ë¦¬
    document.getElementById('logout').onclick = () => {
      localStorage.removeItem('token');
      localStorage.removeItem('username');
      window.location.reload();  // ìƒˆë¡œê³ ì¹¨í•´ì„œ ì´ˆê¸° ìƒíƒœë¡œ
    };

    // ì´ˆê¸° ë¡œë“œ ì‹œ ì´ë¯¸ ë¡œê·¸ì¸ëœ ìƒíƒœë©´ ì¸ì‚¬ë§Â·ë¡œê·¸ì•„ì›ƒ í‘œì‹œ
    window.addEventListener('DOMContentLoaded', () => {
      const user = localStorage.getItem('username');
      if (user) showGreeting(user);
    });

    // ë©”ì‹œì§€ í—¬í¼
    const showMessage = (id, txt) => document.getElementById(id).textContent = txt;

    // íšŒì›ê°€ì… AJAX
    document.getElementById('signup-form').addEventListener('submit', async e => {
      e.preventDefault();
      const data = Object.fromEntries(new FormData(e.target));
      const res  = await fetch('/auth/register', {
        method: 'POST',
        headers: {'Content-Type':'application/json'},
        body: JSON.stringify(data)
      });
      if (res.ok) {
        showMessage('signup-msg','ê°€ì… ì„±ê³µ! ë¡œê·¸ì¸ í•´ì£¼ì„¸ìš”.');
      } else {
        const err = await res.json();
        showMessage('signup-msg', err.detail || 'ê°€ì… ì‹¤íŒ¨');
      }
    });

    // ë¡œê·¸ì¸ AJAX
    document.getElementById('login-form').addEventListener('submit', async e => {
      e.preventDefault();
      const form = new URLSearchParams(new FormData(e.target));
      const res  = await fetch('/auth/token', {
        method: 'POST',
        headers: {'Content-Type':'application/x-www-form-urlencoded'},
        body: form
      });
      if (res.ok) {
        const { access_token } = await res.json();
        const user = form.get('username');
        localStorage.setItem('token', access_token);
        localStorage.setItem('username', user);
        showGreeting(user);
        closeModal('modal-login');
      } else {
        const err = await res.json();
        showMessage('login-msg', err.detail || 'ë¡œê·¸ì¸ ì‹¤íŒ¨');
      }
    });

    // ì¶”ì²œ í¼ AJAX
    document.getElementById('recommend-form').addEventListener('submit', async e => {
      e.preventDefault();
      const params = new URLSearchParams(new FormData(e.target)).toString();
      const token  = localStorage.getItem('token');
      const res    = await fetch(`/recommend?${params}`, {
        headers: token ? {'Authorization':`Bearer ${token}`} : {}
      });
      const { recommendations = [] } = await res.json().catch(()=>({ recommendations: [] }));
      document.getElementById('result').innerHTML = recommendations.length
        ? recommendations.map(item => `
            <div class="paper">
              <strong>${item.title}</strong>
              <em>ì €ì: ${item.authors.map(a=>a.name).join(', ')}</em>
              <p>ê°„í–‰ë¬¼: ${item.publication.name||'N/A'}</p>
              <a href="${item.link_url}" target="_blank">ìƒì„¸ ë³´ê¸°</a>
            </div>
          `).join('')
        : '<p>ì¶”ì²œëœ ë…¼ë¬¸ì´ ì—†ìŠµë‹ˆë‹¤.</p>';
    });

    // ë§ˆì´í˜ì´ì§€(ë¹„ë°€ë²ˆí˜¸ ë³€ê²½) í¼ ì²˜ë¦¬
    document.getElementById('mypage-form').addEventListener('submit', async e => {
      e.preventDefault();
      const data = Object.fromEntries(new FormData(e.target));
      const token = localStorage.getItem('token');
      const res = await fetch('/mypage/password', {
        method: 'PATCH',
        headers: {
          'Content-Type': 'application/json',
          'Authorization': `Bearer ${token}`
        },
        body: JSON.stringify(data)
      });
      if (res.ok) {
        showMessage('mypage-msg','âœ… ë¹„ë°€ë²ˆí˜¸ê°€ ë³€ê²½ë˜ì—ˆìŠµë‹ˆë‹¤.');
        setTimeout(()=>closeModal('modal-mypage'), 1000);
      } else {
        const err = await res.json();
        showMessage('mypage-msg', err.detail || 'âŒ ë³€ê²½ ì‹¤íŒ¨');
      }
    });

  </script>
</body>
</html>
